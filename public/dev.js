// Generated by LiveScript 1.2.0
var toString$ = {}.toString;
function syntaxHighlight(e){return"string"!=typeof e&&(e=JSON.stringify(e,void 0,2)),e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(e){var t="number";return/^"/.test(e)?t=/:$/.test(e)?"key":"string":/true|false/.test(e)?t="boolean":/null/.test(e)&&(t="null"),'<span class="'+t+'">'+e+"</span>"})}
Vue.config.debug = true;
Vue.directive('tip', {
  bind: function(){
    var $ele;
    $ele = $(this.el);
    $ele.attr('title', this.expression);
    $ele.tooltip({
      container: 'body',
      trigger: 'hover'
    });
  },
  update: function(v){
    var $ele;
    $ele = $(this.el);
    $ele.attr('title', v);
    $ele.tooltip('dispose');
    $ele.tooltip({
      container: 'body',
      trigger: 'hover'
    });
  }
});
window.app = new Vue({
  el: '#app',
  data: {
    dbConfig: {},
    dbConfigRaw: '',
    createJobRaw: '',
    info: {
      counts: {},
      queues: []
    },
    jobs: [],
    filter: {
      where: {
        state: void 8,
        type: void 8
      }
    }
  },
  ready: function(){
    setInterval(this.refresh, 2000);
  },
  computed: {
    isDbConfigDirty: function(){
      var newConfig;
      newConfig = (function(){
        try {
          return JSON.parse(this.dbConfigRaw);
        } catch (e$) {}
      }.call(this));
      if (!newConfig) {
        return true;
      }
      return JSON.stringify(newConfig) !== JSON.stringify(this.dbConfig);
    }
  },
  methods: {
    syntaxHighlight: function(it){
      return syntaxHighlight(toString$.call(it).slice(8, -1) === 'Object' ? JSON.stringify(it, void 8, 1) : it);
    },
    changeWhere: function(_where){
      import$(app.filter.where, _where);
      Page("/" + JSON.stringify(app.filter));
    },
    refresh: function(){
      Request.post('/info', app.filter).end(function(err, res){
        app.info = res.body;
      });
      Request.post('/job/get', app.filter).end(function(err, res){
        var i$, ref$, len$, job, j$, ref1$, len1$, log;
        for (i$ = 0, len$ = (ref$ = res.body).length; i$ < len$; ++i$) {
          job = ref$[i$];
          job.timestamp = Moment(job.timestamp).fromNow();
          if (job.logs) {
            for (j$ = 0, len1$ = (ref1$ = job.logs).length; j$ < len1$; ++j$) {
              log = ref1$[j$];
              log.t = Moment(log.t).fromNow();
            }
          }
        }
        app.jobs = res.body;
      });
    },
    reload: function(){
      Request.post('/get-db-config').end(function(err, res){
        delete res.body._id;
        app.dbConfig = res.body;
        app.revertDbConfig();
      });
      this.refresh();
    },
    revertDbConfig: function(){
      app.dbConfigRaw = JSON.stringify(app.dbConfig, null, 2);
    },
    saveDbConfig: function(){
      var newConfig;
      newConfig = (function(){
        try {
          return JSON.parse(app.dbConfigRaw);
        } catch (e$) {}
      }());
      if (!newConfig) {
        alert('Invalid JSON');
        return;
      }
      app.dbConfig = newConfig;
      app.revertDbConfig();
      Request.post('/save-db-config', app.dbConfig).end();
    },
    createJob: function(){
      var job;
      job = (function(){
        try {
          return JSON.parse(app.createJobRaw);
        } catch (e$) {}
      }());
      if (!job) {
        alert('Invalid JSON');
        return;
      }
      Request.post('/job/create', job).end();
      $('#createjob-modal').modal('hide');
    },
    ajax: function(e, o){
      var $ele, href;
      o == null && (o = {});
      $ele = $(e.currentTarget);
      if ($ele.hasClass('disabled')) {
        return;
      }
      href = e.currentTarget.href;
      Request.get(href).end(function(err, res){
        if (o.reload) {
          app.reload();
        }
      });
    }
  }
});
Page.base('/#');
Page('/:filter', function(it){
  var filter, e;
  try {
    filter = JSON.parse(it.params.filter);
    if (!filter.where) {
      return Page.redirect('/{"where":{}}');
    }
    app.filter = filter;
    app.reload();
  } catch (e$) {
    e = e$;
    Page.redirect('/{"where":{}}');
  }
});
Page('*', function(it){
  console.log(it);
  Page.redirect('/{"where":{}}');
});
Page();
function import$(obj, src){
  var own = {}.hasOwnProperty;
  for (var key in src) if (own.call(src, key)) obj[key] = src[key];
  return obj;
}